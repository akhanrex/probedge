<!doctype html>
<meta charset="utf-8" />
<title>Probedge Terminal</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  :root { --bg:#0b0b0d; --card:#121217; --muted:#8c8ca1; --fg:#eaeaf2; --accent:#5cc8ff; --danger:#ff5468; --ok:#46d39a; }
  * { box-sizing:border-box }
  html,body{height:100%}
  body{margin:0;font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter; background:var(--bg); color:var(--fg);}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #1e1e24;position:sticky;top:0;background:rgba(11,11,13,.9);backdrop-filter:blur(6px)}
  h1{font-size:18px;margin:0}
  .grid{display:grid;grid-template-columns:260px 1fr 360px; gap:16px; padding:16px;}
  .col{display:flex;flex-direction:column;gap:16px}
  .card{background:var(--card); border:1px solid #1e1e24; border-radius:14px; padding:12px}
  .card h3{margin:0 0 8px; font-size:14px; color:var(--muted); letter-spacing:.2px}
  select,button,input{background:#0f0f13;border:1px solid #2a2a35;color:var(--fg);border-radius:10px;padding:8px 10px;outline:none}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi{background:#0f0f13;border:1px solid #242432;border-radius:12px;padding:10px}
  .kpi b{display:block;font-size:13px;color:var(--muted)}
  .kpi span{font-size:16px}
  pre{margin:0;white-space:pre-wrap;max-height:38vh;overflow:auto}
  #ticks{font-family:ui-monospace,Menlo,monospace;background:#0f0f13;border:1px solid #242432;border-radius:10px;padding:8px;height:120px;overflow:auto}
  .tick{display:inline-block;margin-right:10px;color:#a7b2c1}
  .tick b{color:#e1e7f0}
  .ok{color:var(--ok)}
  .bad{color:var(--danger)}
  canvas{width:100%;height:280px;background:#0f0f13;border:1px solid #242432;border-radius:12px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px 8px;border-bottom:1px solid #242432;color:#cfd3db}
  th{color:#9aa3b2;text-align:left}
</style>
<header>
  <h1>Probedge Terminal</h1>
  <div class="row">
    <span style="color:#9aa3b2">API: http://127.0.0.1:8000</span>
  </div>
</header>

<div class="grid">
  <!-- Left: Symbols + Filters + Matches -->
  <div class="col">
    <div class="card">
      <h3>Symbols</h3>
      <div class="row">
        <select id="symbol"></select>
        <button id="reloadTm5">Reload</button>
      </div>
      <div style="margin-top:8px">
        <div id="ticks"></div>
      </div>
    </div>

    <div class="card">
      <h3>Tag Filters</h3>
      <div class="row" style="gap:6px">
        <label>OT</label>
        <select id="ot">
          <option>BULL</option><option>BEAR</option><option>TR</option>
        </select>
        <label>OL</label>
        <select id="ol">
          <option>OAR</option><option>OOH</option><option>OIL</option><option>TR</option>
        </select>
        <label>PDC</label>
        <select id="pdc">
          <option>BULL</option><option>BEAR</option><option>TR</option>
        </select>
        <button id="runMatches">Run</button>
      </div>
      <div style="margin-top:8px">
        <table id="matchesTbl">
          <thead><tr><th>Date</th><th>OT</th><th>OL</th><th>PDC</th><th>Result</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="matchesMeta" style="color:#9aa3b2;margin-top:6px"></div>
      </div>
    </div>
  </div>

  <!-- Middle: KPIs + Chart -->
  <div class="col">
    <div class="card">
      <h3>Portfolio KPIs (/api/journal/daily)</h3>
      <div class="kpis" id="kpis"></div>
    </div>
    <div class="card">
      <h3 id="chartTitle">Intraday Close (/api/tm5)</h3>
      <canvas id="chart"></canvas>
    </div>
  </div>

  <!-- Right: Plan / State -->
  <div class="col">
    <div class="card">
      <h3>Plan / Timeline (/api/state)</h3>
      <div id="stateBox"><em style="color:#9aa3b2">loading…</em></div>
      <div class="row" style="margin-top:8px">
        <button id="refreshState">Refresh</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
const API = "";
const el = (id)=>document.getElementById(id);
const symSel = el("symbol");
const kpis   = el("kpis");
const ticks  = el("ticks");
const chartTitle = el("chartTitle");
const ctx = el("chart").getContext("2d");
let chart;

// basic helpers
const fmt = (n)=> (typeof n==="number") ? (Math.abs(n)>=100? n.toFixed(1) : (Math.abs(n)>=1? n.toFixed(2): n.toFixed(3))) : n;
function setKpis(m){
  const items = [
    ["Days", m.Days], ["Total_RS", fmt(m.Total_RS)], ["Avg_Daily_RS", fmt(m.Avg_Daily_RS)],
    ["Sharpe_dR", fmt(m.Sharpe_dR)], ["Sortino_dR", fmt(m.Sortino_dR)], ["%Green", m["%Green"]],
    ["LosingStreak_days", m.LosingStreak_days], ["Annual_R", fmt(m.Annual_R)],
    ["MaxDD_RS", fmt(m.MaxDD_RS)], ["Calmar", fmt(m.Calmar)], ["Ulcer", fmt(m.Ulcer)]
  ];
  kpis.innerHTML = items.map(([k,v])=>`<div class="kpi"><b>${k}</b><span>${v}</span></div>`).join("");
}

async function loadConfig(){
  const r = await fetch("/api/config"); const j = await r.json();
  const syms = j.symbols || j.data || [];
  symSel.innerHTML = syms.map(s=>`<option>${s}</option>`).join("");
  if (syms.length) await loadTm5(syms[0]);
}

async function loadKpis(){
  const r = await fetch("/api/journal/daily"); const j = await r.json();
  setKpis(j.metrics || {});
}

function makeChart(labels, closes, sym){
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label: sym+" Close", data: closes, tension:.2 }] },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}} }
  });
}

async function loadTm5(sym){
  chartTitle.textContent = `Intraday Close (/api/tm5?symbol=${sym})`;
  const r = await fetch(`/api/tm5?symbol=${encodeURIComponent(sym)}`); const j = await r.json();
  const rows = (j.data||[]).slice(-200);
  const labels = rows.map(x=>x.DateTime);
  const closes = rows.map(x=>x.Close);
  makeChart(labels, closes, j.symbol||sym);
}

async function loadState(){
  try{
    const r = await fetch("/api/state"); const j = await r.json();
    const steps = (j.steps||[]).map(s=>`<div>• <b>${s.step}</b> — ${s.note} <span style="color:#9aa3b2">${s.ts}</span></div>`).join("");
    el("stateBox").innerHTML = `
      <div><b>Date:</b> ${j.date||"-"}</div>
      <div><b>Status:</b> ${j.status||"-"}</div>
      <div style="margin-top:6px"><b>Steps</b></div>
      ${steps || "<em style='color:#9aa3b2'>no steps yet</em>"}
    `;
  }catch(e){
    el("stateBox").innerHTML = `<span style="color:#ff5468">/api/state not available</span>`;
  }
}

function connectWS(){
  const ws = new WebSocket(`${location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/live`);
  ws.onmessage = (ev)=>{
    try{
      const obj = JSON.parse(ev.data);
      const items = obj.ticks.map(([s,p])=>`<span class="tick"><b>${s}</b> ${fmt(p)}</span>`);
      ticks.innerHTML = items.join("");
    }catch(e){ /* ignore */ }
  };
  ws.onclose = ()=> setTimeout(connectWS, 1500);
}

async function runMatches(){
  const sym = symSel.value, ot = el("ot").value, ol = el("ol").value, pdc = el("pdc").value;
  const url = `/api/matches?symbol=${encodeURIComponent(sym)}&ot=${ot}&ol=${ol}&pdc=${pdc}`;
  const r = await fetch(url); const j = await r.json();
  const dates = j.dates||[];
  const cols  = j.cols||["Date","OpeningTrend","OpenLocation","PrevDayContext","Result"];
  const tbody = el("matchesTbl").querySelector("tbody");
  tbody.innerHTML = dates.map((d,i)=>{
    return `<tr><td>${d}</td><td>${ot}</td><td>${ol}</td><td>${pdc}</td><td>-</td></tr>`;
  }).join("");
  el("matchesMeta").textContent = `Rows: ${j.rows} • Symbol: ${j.symbol}`;
}

document.getElementById("reloadTm5").onclick = ()=> loadTm5(symSel.value);
document.getElementById("runMatches").onclick = runMatches;
document.getElementById("refreshState").onclick = loadState;
symSel.onchange = ()=> loadTm5(symSel.value);

connectWS();
loadConfig();
loadKpis();
loadState();
setInterval(loadKpis, 15000);

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Probedge Live</title>
<style>
  :root { --bg:#0b0f14; --fg:#e7edf5; --card:#121720; --muted:#92a2b2; --accent:#00d3a7; --warn:#ffb020; --bad:#ff5d5d; --good:#31d0a0; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,Segoe UI,Roboto}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #1b2330;background:#0c121a;position:sticky;top:0;z-index:5}
  .app{padding:18px;display:grid;gap:18px;grid-template-columns: 320px 1fr}
  .leftcol{display:grid;gap:18px}
  .card{background:var(--card);border:1px solid #1b2230;border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  h1{margin:0;font-size:18px;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:12px}
  .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .kpi{background:#0e141c;border:1px solid #1a2433;border-radius:12px;padding:10px}
  .kpi .v{font-weight:700;font-size:18px;margin-top:4px}
  .tags{width:100%;border-collapse:collapse;font-size:13px}
  .tags th,.tags td{border-bottom:1px solid #1a2433;padding:6px 8px;text-align:left}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600;letter-spacing:.3px}
  .PDC.BULL{background:#102e19;color:#55ffac;border:1px solid #224c34}
  .PDC.BEAR{background:#341a1a;color:#ff8d8d;border:1px solid #5a2a2a}
  .PDC.TR{background:#162232;color:#7fb3ff;border:1px solid #2a3d5a}
  .OL.OOH{background:#281a34;color:#d9a7ff;border:1px solid #3f2a5a}
  .OL.OOL{background:#1a2f34;color:#90f0ff;border:1px solid #2b535a}
  .OL.OAR{background:#2a2f1a;color:#e6ffa6;border:1px solid #475a2b}
  .OT.BULL{background:#0f2b1c;color:#54ffb0;border:1px solid #225041}
  .OT.BEAR{background:#3a1a1a;color:#ffa3a3;border:1px solid #5a2c2c}
  .OT.TR{background:#141e2a;color:#9bc1ff;border:1px solid #2b3f5a}
  .row{display:flex;align-items:center;gap:10px}
  .row label{color:var(--muted)}
  select,button{background:#0d151f;color:var(--fg);border:1px solid #203046;border-radius:10px;padding:8px 10px}
  button{cursor:pointer}
  .ltpgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .ltpitem{display:flex;justify-content:space-between;padding:8px;border:1px solid #223047;border-radius:10px;background:#0d141d}
  canvas{width:100%;height:240px;background:#0d141d;border:1px solid #1a2433;border-radius:12px}
  .meta{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div>
    <h1>Probedge Live</h1>
    <div class="sub">WS ticks • Tag Matrix • KPIs • TM5 spark</div>
  </div>
  <div class="row">
    <label>Symbol</label>
    <select id="symSel"></select>
    <button id="refreshBtn">Refresh</button>
  </div>
</header>

<div class="app">
  <div class="leftcol">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <strong>Live LTP</strong>
        <span class="meta">/ws/live</span>
      </div>
      <div id="ltpGrid" class="ltpgrid"></div>
    </div>
    <div class="card">
      <strong>Tags (today)</strong> <span class="meta">/api/state</span>
      <table class="tags" id="tagTable">
        <thead><tr><th>Symbol</th><th>PDC</th><th>OL</th><th>OT</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="kpis" id="kpis"></div>
    <div style="margin:10px 0 6px; display:flex; justify-content:space-between">
      <div><strong id="sparkTitle">TMPV</strong> last 120 bars</div>
      <span class="meta">/api/tm5</span>
    </div>
    <canvas id="spark"></canvas>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const symSel = $("symSel");
const ltpGrid = $("ltpGrid");
const tagTable = $("tagTable").querySelector("tbody");
const kpisBox = $("kpis");
const spark = $("spark");
let SYMS = [];

async function fetchJSON(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(u+" → "+r.status); return r.json(); }

function pill(kind,val){
  const d=document.createElement("span");
  d.className = "pill "+kind+" "+String(val||'').toUpperCase();
  d.textContent = String(val||'-').toUpperCase();
  return d;
}

async function loadConfig(){
  const j = await fetchJSON("/api/config");
  SYMS = j.symbols || [];
  symSel.innerHTML = SYMS.map(s=>`<option value="${s}">${s}</option>`).join("");
}

async function loadKPIs(){
  const j = await fetchJSON("/api/journal/daily");
  const m = j.metrics || {};
  const fields = [
    ["Days", m.Days], ["%Green", (m["%Green"]*100).toFixed(1)+"%"],
    ["Sharpe_dR", m.Sharpe_dR?.toFixed(2)], ["Sortino_dR", m.Sortino_dR?.toFixed(2)],
    ["Annual_R", (m.Annual_R*100).toFixed(1)+"%"], ["MaxDD_RS", (m.MaxDD_RS*100).toFixed(1)+"%"],
    ["Calmar", (m.Calmar===Infinity?"∞":(m.Calmar||0).toFixed(2))], ["Ulcer", (m.Ulcer||0).toFixed(1)]
  ];
  kpisBox.innerHTML = fields.map(([k,v])=>`<div class="kpi"><div class="sub">${k}</div><div class="v">${v??"-"}</div></div>`).join("");
}

async function loadState(){
  const j = await fetchJSON("/api/state");
  const tags = j.tags || {};
  // table
  tagTable.innerHTML = (SYMS.length?SYMS:Object.keys(tags)).map(s=>{
    const t = tags[s] || {};
    return `<tr>
      <td>${s}</td>
      <td>${pill("PDC",t.PDC).outerHTML}</td>
      <td>${pill("OL", t.OL ).outerHTML}</td>
      <td>${pill("OT", t.OT ).outerHTML}</td>
    </tr>`;
  }).join("");

  // left LTP list seed
  ltpGrid.innerHTML = (SYMS.length?SYMS:Object.keys(tags)).map(s=>`
    <div class="ltpitem"><span>${s}</span><strong id="ltp_${s}">-</strong></div>
  `).join("");
}

async function loadSpark(sym){
  $("sparkTitle").textContent = sym;
  const j = await fetchJSON(`/api/tm5?symbol=${encodeURIComponent(sym)}`);
  const arr = j.data || [];
  const last = arr.slice(-120);
  const pts = last.map(r=>({t:new Date(r.DateTime), c:+r.Close})).filter(p=>Number.isFinite(p.c));
  drawSpark(pts);
}

function drawSpark(pts){
  const ctx = spark.getContext("2d");
  const w = spark.clientWidth, h = spark.clientHeight;
  canvasResize(spark, w, h);
  ctx.clearRect(0,0,w,h);
  if(!pts.length) return;

  const xs = pts.map(p=>p.t.getTime());
  const ys = pts.map(p=>p.c);
  const minx = Math.min(...xs), maxx = Math.max(...xs);
  const miny = Math.min(...ys), maxy = Math.max(...ys);
  const pad = 10;

  // axes
  ctx.strokeStyle = "#1f2a3a"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(pad,pad);   ctx.lineTo(pad,h-pad);   ctx.stroke();

  // line
  ctx.strokeStyle = "#5cc8ff"; ctx.lineWidth=1.8; ctx.beginPath();
  pts.forEach((p,i)=>{
    const x = pad + (w-2*pad) * ( (p.t.getTime()-minx) / Math.max(1,(maxx-minx)) );
    const y = h-pad - (h-2*pad) * ( (p.c - miny) / Math.max(1e-9,(maxy-miny)) );
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // last price marker
  const last = pts[pts.length-1];
  const lx  = pad + (w-2*pad) * ((last.t.getTime()-minx)/Math.max(1,(maxx-minx)));
  const ly  = h-pad - (h-2*pad) * ((last.c-miny)/Math.max(1e-9,(maxy-miny)));
  ctx.fillStyle="#0b0f14"; ctx.strokeStyle="#2b3f57";
  ctx.beginPath(); ctx.arc(lx,ly,4,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle="#bcd3ea"; ctx.fillText(last.c.toFixed(2), Math.min(w-pad-40,lx+6), ly-6);
}
function canvasResize(c,w,h){ const dpr = window.devicePixelRatio||1; c.width=Math.round(w*dpr); c.height=Math.round(h*dpr); c.style.width=w+"px"; c.style.height=h+"px"; const ctx=c.getContext("2d"); ctx.setTransform(dpr,0,0,dpr,0,0); }

function connectWS(){
  const ws = new WebSocket((location.protocol==="https:"?"wss":"ws")+"://"+location.host+"/ws/live");
  ws.onmessage = (ev)=>{
    try{
      const obj = JSON.parse(ev.data);
      (obj.ticks||[]).forEach(([s,px])=>{
        const el = $("ltp_"+s); if(el){ el.textContent = px.toFixed ? px.toFixed(2) : px; }
      });
    }catch(_){}
  };
  ws.onclose = ()=> setTimeout(connectWS, 1500);
}

$("refreshBtn").onclick = async ()=>{
  await Promise.all([loadKPIs(), loadState(), loadSpark(symSel.value)]);
};

symSel.onchange = ()=> loadSpark(symSel.value);

// boot
(async function init(){
  await loadConfig();
  await loadKPIs();
  await loadState();
  const def = symSel.value || (SYMS[0]||"TMPV");
  await loadSpark(def);
  connectWS();
  // periodic KPI refresh
  setInterval(loadKPIs, 20000);
})();
</script>
</body>
</html>

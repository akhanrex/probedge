name: Restructure Repo (one-click)

on:
  workflow_dispatch: {}

jobs:
  restructure:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create new branch
        run: |
          BR="restructure-${{ github.run_id }}"
          echo "BRANCH=$BR" >> $GITHUB_ENV
          git switch -c "$BR"

      - name: Create folders
        run: |
          mkdir -p app probedge config data/masters data/latest data/journal scripts assets .github/workflows notebooks

      - name: Move files to new layout
        run: |
          set -e
          test -f app.py && git mv app.py app/app.py || true
          test -f ui.py && git mv ui.py app/ui.py || true
          test -f journal_tab.py && git mv journal_tab.py app/journal_tab.py || true
          test -f weekly_updater.py && git mv weekly_updater.py probedge/weekly_updater.py || true
          test -f journal_utils.py && git mv journal_utils.py probedge/journal_utils.py || true
          test -f github_utils.py && git mv github_utils.py probedge/github_utils.py || true
          test -f github_sync.py && git mv github_sync.py probedge/github_sync.py || true
          test -f journal_config.yaml && git mv journal_config.yaml config/journal_config.yaml || true
          test -f main/journal_fees.yaml && git mv main/journal_fees.yaml config/journal_fees.yaml || true
          test -f TataMotors_Master.csv && git mv TataMotors_Master.csv data/masters/TataMotors_Master.csv || true
          test -f Bitcoin_Master.csv && git mv Bitcoin_Master.csv data/masters/Bitcoin_Master.csv || true
          test -f ES_Master.csv && git mv ES_Master.csv data/masters/ES_Master.csv || true
          test -f Journal.csv && git mv Journal.csv data/journal/Journal.csv || true
          test -f fees.py && git mv fees.py scripts/fees.py || true
          test -f probedge_main.PNG && git mv probedge_main.PNG assets/probedge_main.png || true

      - name: Add __init__.py and update config path
        run: |
          touch app/__init__.py probedge/__init__.py
          git add app/__init__.py probedge/__init__.py
          if [ -f config/journal_config.yaml ]; then
            sed -i 's|MASTER_DEFAULT_PATH: *"./TataMotors_Master.csv"|MASTER_DEFAULT_PATH: "data/masters/TataMotors_Master.csv"|' config/journal_config.yaml || true
            git add config/journal_config.yaml
          fi

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if ! git diff --cached --quiet || ! git diff --quiet; then
            git add -A
            git commit -m "chore: repo restructure to production layout"
            git push -u origin "$BRANCH"
          else
            echo "No changes to commit."
          fi

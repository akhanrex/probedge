from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
<<<<<<< HEAD
import os

# -------- app base --------
app = FastAPI(title="ProbEdge API", version="0.1.0")

# CORS (env ALLOWED_ORIGINS or "*")
origins_env = os.environ.get("ALLOWED_ORIGINS", "*")
allow_origins = [o.strip() for o in origins_env.split(",")] if origins_env else ["*"]
app.add_middleware(
    CORSMiddleware,
    allow_origins=allow_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Health (keep it inline)
@app.get("/api/health")
def health():
    return {"ok": True}

# -------- routers --------
# Required
from apps.api.routes import tm5 as tm5_route
from apps.api.routes import config as config_route
from apps.api.routes import matches as matches_route
from apps.api.routes import settings_debug as settings_debug_route
from apps.api.routes import journal as journal_route

# Optional (guarded)
try:
    from apps.api.routes import state_file as state_route
    app.include_router(state_route.router)
except Exception:
    pass

# Include ours last (last wins)
app.include_router(config_route.router)
app.include_router(tm5_route.router)
app.include_router(matches_route.router)
app.include_router(settings_debug_route.router)
app.include_router(journal_route.router)
=======
from .routes import config, journal, kill, matches, state, tm5
from .routes import state_file
from apps.api.routes import control as control_route
from apps.api.routes import state_stream as state_stream_route
from apps.api.routes import plan as plan_route
from .ws import live as wslive
app = FastAPI(title="Probedge API")
app.include_router(config.router)
app.include_router(tm5.router)
app.include_router(matches.router)
app.include_router(state_file.router)
app.include_router(plan_route.router)
# # app.include_router(state.router)  # disabled  # disabled in favor of file-backed state
app.include_router(journal.router)
app.include_router(kill.router)
app.include_router(wslive.router)
app.include_router(tm5_route.router)
app.include_router(matches_route.router)
app.include_router(control_route.router)
app.include_router(state_stream_route.router)
app.add_middleware(CORSMiddleware,allow_origins=["*"],allow_credentials=True,allow_methods=["*"],allow_headers=["*"])
@app.get("/api/health")
def health(): return {"ok": True}


# --- Live 5-min aggregator autostart ---
import asyncio
from probedge.infra.settings import SETTINGS
from probedge.realtime.agg5 import run_agg


from probedge.decision.timeline import run_timeline
@app.on_event("startup")
async def _agg_start():
    if SETTINGS.mode == "live":
        app.state.agg_task = asyncio.create_task(run_agg(SETTINGS.symbols))
        app.state.timeline_task = asyncio.create_task(run_timeline())

@app.on_event("shutdown")
async def _agg_stop():
    t = getattr(app.state, "agg_task", None)
    if t:
        t.cancel()

app.mount("/ui", StaticFiles(directory="apps/api/static", html=True), name="ui")
>>>>>>> cf9217d05d29113c1a750b92ca08c0724b617d75

# ---- static (index.html / terminal.html)
app.mount("/", StaticFiles(directory="apps/api/static", html=True))
